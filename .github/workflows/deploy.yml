name: Deploy e-convenio

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - name: 🔄 Checkout do código
      uses: actions/checkout@v3

    - name: 📦 Instalar e testar backend
      run: |
        cd backend
        npm install
        npm test

    - name: 📦 Instalar e testar frontend
      run: |
        cd frontend
        npm install
        npm test

    - name: 🐳 Build das imagens Docker com tag
      run: |
        docker build -t e-convenio-backend:${IMAGE_TAG} ./backend
        docker build -t e-convenio-frontend:${IMAGE_TAG} ./frontend

    - name: 📦 Exportar imagens Docker
      run: |
        docker save e-convenio-backend:${IMAGE_TAG} -o backend.tar
        docker save e-convenio-frontend:${IMAGE_TAG} -o frontend.tar

    - name: 🔐 Adicionar host ao known_hosts
      run: ssh-keyscan -H ${{ secrets