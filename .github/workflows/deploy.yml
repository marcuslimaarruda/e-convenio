name: Deploy e-convenio

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - name: ðŸ”„ Checkout do cÃ³digo
      uses: actions/checkout@v3

    - name: ðŸ“¦ Instalar dependÃªncias do backend
      run: |
        cd backend
        npm ci
        npm test

    - name: ðŸ“¦ Instalar dependÃªncias do frontend
      run: |
        cd frontend
        npm ci
        npm test

    - name: ðŸ³ Build das imagens Docker com tag
      run: |
        docker build -t e-convenio-backend:${IMAGE_TAG} ./backend
        docker build -t e-convenio-frontend:${IMAGE_TAG} ./frontend

    - name: ðŸ“¦ Exportar imagens Docker
      run: |
        docker save e-convenio-backend:${IMAGE_TAG} -o backend.tar
        docker save e-convenio-frontend:${IMAGE_TAG} -o frontend.tar

    - name: ðŸ” Adicionar host ao known_hosts
      run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        port: 22
        source: "backend.tar,frontend.tar,docker-compose.yml"
        target: "/home/marcus/e-convenio"

    - name: ðŸ”§ Rodar containers na VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        port: 22
        script: |
          cd /home/marcus/e-convenio
          docker load -i backend.tar
          docker load -i frontend.tar
          docker-compose up -d
          docker-compose ps
          docker image prune -f
