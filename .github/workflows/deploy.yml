name: Deploy e-convenio via Helm

on:
  push:
    branches: [ master ]

jobs:
  helm-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - name: 🔄 Checkout do código
      uses: actions/checkout@v3

    - name: 📦 Compactar Helm Chart
      run: |
        tar -czf helm-e-convenio.tar.gz helm-e-convenio

    - name: 🔐 Adicionar host ao known_hosts
      run: ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

    - name: 🚚 Enviar Helm Chart para a VM
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        port: 22
        source: "helm-e-convenio.tar.gz"
        target: "/home/marcus"

    - name: 🚀 Executar deploy via Helm na VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        port: 22
        script: |
          cd /home/marcus
          rm -rf helm-e-convenio
          tar -xzf helm-e-convenio.tar.gz
          helm upgrade --install e-convenio ./helm-e-convenio \
            --namespace e-convenio-dev \
            --set backend.tag=${{ github.sha }} \
            --set frontend.tag=${{ github.sha }}
